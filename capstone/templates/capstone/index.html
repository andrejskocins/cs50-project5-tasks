{% extends "capstone/layout.html" %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentSort = { column: null, ascending: true };
    
    function sortTable(column, index) {
        const taskList = document.querySelector('.task-list');
        const items = Array.from(document.querySelectorAll('.task-item'));
        
        // Toggle sort direction if clicking same column
        if (currentSort.column === column) {
            currentSort.ascending = !currentSort.ascending;
        } else {
            currentSort.column = column;
            currentSort.ascending = true;
        }
        
        // Sort the items
        items.sort((a, b) => {
            const aCell = a.children[index];
            const bCell = b.children[index];
            let aVal = aCell.dataset.sort ?? aCell.textContent.trim();
            let bVal = bCell.dataset.sort ?? bCell.textContent.trim();

            if (column === 'start_time' || column === 'due_date') {
                // Use ISO strings or epoch seconds if provided
                const aDate = isNaN(aVal) ? new Date(aVal).getTime() : Number(aVal);
                const bDate = isNaN(bVal) ? new Date(bVal).getTime() : Number(bVal);
                if (aDate < bDate) return currentSort.ascending ? -1 : 1;
                if (aDate > bDate) return currentSort.ascending ? 1 : -1;
                return 0;
            }

            // String comparison, case-insensitive
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
            if (aVal < bVal) return currentSort.ascending ? -1 : 1;
            if (aVal > bVal) return currentSort.ascending ? 1 : -1;
            return 0;
        });
        
        // Update the DOM
        items.forEach(item => taskList.appendChild(item));
        
        // Update arrows
        document.querySelectorAll('.sortable').forEach(el => {
            el.innerHTML = el.innerHTML.replace(/▲|▼/g, '').trim();
        });
        document.querySelector(`[data-column="${column}"]`).innerHTML += 
            currentSort.ascending ? ' ▲' : ' ▼';
    }
    
    document.querySelectorAll('.sortable').forEach(el => {
        el.addEventListener('click', function(e) {
            e.preventDefault();
            const column = this.dataset.column;
            const index = parseInt(this.dataset.index);
            sortTable(column, index);
        });
    });

    document.querySelectorAll('.task-title-button').forEach(el => {
        el.addEventListener('click', function(e) {
            e.preventDefault();
            const taskItem = this.closest('.task-item');
            let descriptionArea = taskItem.nextElementSibling;
            
            if (descriptionArea && descriptionArea.classList.contains('task-description-area')) {
                // Toggle existing description area
                descriptionArea.classList.toggle('expanded');
            } else {
                // Create new description area
                descriptionArea = document.createElement('div');
                descriptionArea.className = 'task-description-area';
                const description = this.getAttribute('data-description') || 'No description';
                descriptionArea.innerHTML = '<div class="task-description-content"><p>' + description + '</p></div>';
                taskItem.parentNode.insertBefore(descriptionArea, taskItem.nextSibling);
                // Trigger reflow and add expanded class for animation
                descriptionArea.offsetHeight;
                descriptionArea.classList.add('expanded');
            }
        })
    })

    // Task action buttons
    document.querySelectorAll('.task-complete-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const taskItem = this.closest('.task-item');
            const taskId = taskItem.dataset.taskId;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             document.querySelector('meta[name="csrf-token"]')?.content || '';
            
            fetch(`/task/${taskId}/toggle`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    taskItem.classList.toggle('completed');
                    const checkbox = taskItem.querySelector('.task-checkbox');
                    checkbox.checked = !checkbox.checked;
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    document.querySelectorAll('.task-delete-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Are you sure you want to delete this task?')) {
                const taskItem = this.closest('.task-item');
                const taskId = taskItem.dataset.taskId;
                
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                 document.querySelector('meta[name="csrf-token"]')?.content || '';
                
                fetch(`/task/${taskId}/delete`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        taskItem.remove();
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    });

});
</script>
{% endblock %}

{% block body %}

<div class="page-content">
    <div class="task-controls">
        <div>
            <select name="category" id="category">
                <option value="all-tasks">All Tasks</option>
                <option value="">All Tasks</option>
            </select>
        </div>
        <div class="add-task-button">
            <button id="open-task-modal" data-open-task-modal class="btn btn-primary" type="button">Add Task</button>
        </div>
    </div>

    <div class="task-list">
    <div class="task-header flex-container">
        <div></div>
        <div class="sortable" data-column="title" data-index="1">TASK</div>
        <div class="sortable" data-column="buttons" data-index="2"></div>
        <div class="sortable" data-column="author" data-index="3">AUTHOR</div>
        <div class="sortable" data-column="start_time" data-index="4">START DATE</div>
        <div class="sortable" data-column="due_date" data-index="5">DUE DATE</div>
    </div>
    {% for task in tasks %}
        <div class="task-item flex-container {% if task.completed %}completed{% endif %}" data-task-id="{{ task.id }}">
            <div><input type="checkbox" class="task-checkbox"></div>
            <div class="task-title"><button class="task-title-button" data-description="{{ task.description }}">{{ task.title }}</button></div>
            <div class="task-action-buttons">
                <button class="task-complete-btn" title="Mark as completed">✓</button>
                <button class="task-delete-btn" title="Delete task">✕</button>
            </div>
            <div class="task-author" data-sort="{{ task.author.username|lower }}">{{ task.author.username }}</div>
            <div class="task-start-date" data-sort="{{ task.start_time|date:'c' }}">{{ task.start_time|date:"Y-m-d H:i" }}</div>
            <div class="task-due-date" {% if task.due_date %}data-sort="{{ task.due_date|date:'c' }}"{% endif %}>
                {% if task.due_date %}{{ task.due_date|date:"M d" }}{% else %}&nbsp;{% endif %}
            </div>
        </div>
    {% empty %}
        <p>No tasks here.</p>
    {% endfor %}
    </div>
</div>

{% block modals %}{% endblock %}

{% endblock %}